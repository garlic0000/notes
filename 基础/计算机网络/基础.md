## 概述

### 1.计算机网络在信息时代中的作用

* 三类网络：电信网络，有线电视网络，计算机网络

* 互联网的特点：连通性，共享

* 计算机网络提供的服务：

  计算机网络可以向用户提供多种服务，计算机网络是一种基础设施，各种应用程序是在计算机网络之上运行的，由于新的应用程序不断出现，计算机网络能向用户提供的服务也是多种多样



注意：

* Internet不要译为国际互联网，互联网本身是覆盖全球的，因此“国际”二字是多余的。

* 对于仅在局域范围互连起来的计算机网络，只能称之为互连网，而不是互联网。

  很早以前提出的“三网融合”，不太容易实现，因为这涉及到各方面的经济利益和行政管辖权的问题。

* 因特网和互联网

  虽然因特网这个译名更准确，但却长时间未得到推广

  互联网这个译名能够体现出Internet最主要的特征

  

### 2.互联网概述

（1）互联网基础结构发展的三个阶段

* 从单个网络APPANET向互连网发展的过程

* 建成了三级结构的互联网，主干网，地区网和校园网（企业网）

* 逐渐形成了多层次ISP结构的互联网

  任何机构和个人只要向ISP交纳规定的费用，就可以从ISP得到所需的IP地址，并通过ISP接入到互联网

（2）互连网，互联网

* 计算机网络由若干节点和连接这些节点的链路组成，网络中的节点可以是计算机、集线器、交换机、或路由器等

* 网络之间可以通过路由器互连起来，这样的网络称为互连网

* 网络把许多计算机连接在一起，而互连网把许多网络通过路由器连接在一起

* internet（互连网）是一个通用名词，它泛指由多个计算机网络互连而成的计算机网络

  采用的通信协议可以任意选择，不一定非要用TCP/IP协议

* Internet（互联网）是一个专用名词，它指当前全球最大的、开放的、由众多网络相互连接而成的特定互连网

  采用TCP/IP协议族作为通信规则，且其前身是美国的ARPANET

（3）制定互联网的正式标准

* 互联网草案

  互联网草案的有效期只有6个月，这个阶段还不能算是RFC文档

* 建议标准

  从这个阶段开始就成为RFC文档

* 互联网标准

  达到正式标准后，每个标准就分配到一个编号STDxx

注意：

* 互联网交换点IXP的主要作用就是允许两个网络直接相连并交换分组，而不需要再通过第三个网络来转发分组

* IXP常工作在数据链路层的网络交换机，这些网络交换机都用局域网互连起来

  

  

### 3.互联网的组成

（1）两大块：边缘部分，核心部分

边缘部分：

* 由所有连接在互联网上的主机组成，这部分是用户直接使用的，用来进行通信和资源共享
* 边缘的通信方式：C/S方式，P2P方式

核心部分：

* 由大量网络和连接这些网络的路由器组成，这部分是为边缘部分提供服务的（提供连通性和交换）
* 互联网核心部分的工作方式其实就是路由器的工作方式
* 互联网的核心部分的工作方式：路由器转发分组，路由器之间不断交换路由信息

（2）C/S方式与P2P方式

C/S方式：

* C/S方式所描述是进程之间服务与被服务的关系，客户是服务请求方，服务器是服务提供方，两者都要使用网络核心部分所提供的服务
* 客户与服务器的通信关系建立后，通信是双向的

* 客户程序：
  * 被客户调用后运行，在通信时主动向远地服务器发起通信
  * 客户程序必须知道服务器程序的地址
  * 不需要很特殊的硬件和很复杂的操作系统
* 服务器程序：
  * 专门用来提供某种服务的程序，可同时处理多个远地或本地客户的请求
  * 系统启动后即自动调用着并一直不断的运行，被动的等待各地客户请求
  * 服务器不需要知道客户程序的地址
  * 一般需要强大的硬件和高级的操作系统支持

对等连接（P2P）：

* 两台主机在通信时并不区分哪一个是服务请求方哪一个是服务提供方
* 两台主机都运行了对等连接软件
* 双方都可以下载对方已经存储在硬盘中的共享文档
* 对等连接方式从本质上仍然是使用客户-服务器方式，只是对等连接中的每一个主机既是客户又是服务器



（3）电路交换，报文交换，分组交换

注意：

* 路由器是实现分组交换的关键构件，其任务是转发收到的分组

* 交换是指按照某种方式动态地分配传输线路的资源

电路交换：

* 通信过程是建立连接，通信，释放连接

* 在通信的过程中，通信的双方始终占用端到端的通信资源，占用所使用的物理信道
* 线路的效率往往很低
* 当通信网业务很大时，电路交换无法保证每个用户都能连通
* 在整个连接中，只要有一个环节出了故障，整个连接就不存在，需要重新连接
* 只要能够建立连接，双方通信所需要的传输宽带就已经分配好而不会再改变，不会受其他网络用户的影响，整个过程的传输速率不变

分组交换：

* 分组交换采用存储转发技术，分组是互联网中传送的数据单元

* 分组交换没有连接建立和连接释放这两个阶段，传输数据比较迅速

* 分组交换对通信链路是逐段占用，分组在哪段链路上传送才占用这段链路的通信资源，不同链路上传输速率会不同

* 分组交换采用分布式路由选择协议，当网络中某个结点出现故障时，分组传送的路由会自适应的动态改变

* 分组交换具有高效，灵活，迅速，可靠的特点

* 带来的两个问题：

  分组在路由器存储转发时需要排队，会造成一定的时延

  各分组必须携带的控制信息也造成了一定的开销

报文交换：

* 报文交换也采用存储转发技术
* 报文交换不再把报文分割为更小的分组
* 省去了划分小的分组的时间，也省去了把分组重装成报文的过程
* 灵活性不如分组交换，传输数据的时延较大

注意：

* 若连续传送大量的数据，且其传送时间远大于连接建立时间，则电路交换的传输效率更高
* 报文交换和分组交换不需要预先分配带宽，在传送突发数据时可提高整个网络的信道利用率
* 分组交换比报文交换时延少，更灵活
* 存储转发：路由器每收到一个分组，先暂时存下来，再检查其首部，查找转发表，按照首部中的目的地址，找到合适的接口转发出去

### 4.计算机网络的类别

（1）作用范围：

* 广域网WAN

  作用范围通常为几十到几千公里，有时也称远程网

* 城域网MAN

  作用范围一般是一个城市，可跨越几个街区甚至城市，其作用距离约为5～50km

* 局域网LAN

  作用范围局限在较小的范围（如1km左右）

* 个人区域网PAN

  常称无限个人区域网WPAN，其作用范围大约在10km

（2）网络使用者：

* 公用网

  电信公司出资建造的大型网络，只要所有愿意按电信公司的规定交纳费用的人都可以使用这种网络

* 专用网

  某个部门为满足本单位特殊业务的需要而建造的网络，这种网络不向单位以外的人提供服务

（3）把用户接入到互联网的网络：

* 接入网AN

  接入网本身既不属于互联网的核心部分，也不属于互联网的边缘部分

  接入网是从某个用户端系统到互联网中的第一个路由器（边缘路由器）之间的网络

（4）按照采用的交换技术

* 电路交换网
* 分组交换网
* 混合交换网

注意：

* 计算机网路中主干网是计算机网络核心部分的重要组成部分

* 本地接入网的作用仅仅是用来把用户接入到互联网

  

### 5.计算机网络的性能

（1）性能指标：

* 速率

  数据的传输速率，也称为数据率或比特率

  速率的单位是bit/s，b/s，bps

  1k = 1000

  提到网络的速率时，往往指的是额定速率或标称速率，而非网络实际上运行的速率

  

* 带宽

  带宽本来是指某个信号具有的频带宽度

  在计算机网络中带宽表示网络中某通道传送数据的能力

  网络宽带表示在单位时间内网络中的某信道所能通过的“最高数据率”

  单位bit/s

  

* 吞吐量

  表示在单位时间内通过某个网络的实际的数据量

  单位bit/s

  有时吞吐量还可用每秒传送的字节数或帧数来表示

  

* 时延

  数据从网络的一端传送到另一端所需的时间

  总时延 = 发送时延 + 传播时延 + 处理时延 + 排队时延

  * 发送时延

    主机或路由器发送数据帧所需要的时间

    发送时延 = 数据帧长度（bit）/发送速率（bit/s）

  * 传播时延

    电磁波在信道中传播一定距离需要花费的时间

    传播时延 = 信道长度（m）/电磁波在信道上的传播速率（m/s）

  * 处理时延

    主机或路由器在收到分组时要花费一定的时间进行处理

  * 排队时延

    分组在进入路由器后要先在输入队列中排队等待处理

  注意：

  * 并非在任何情况下，提高发送速率就能减少总时延

  * 对于高速网络链路，我们提高的仅仅是数据的发送速率而不是比特在链路上的传播速率

  * 提高发送速率仅仅是减少了发送时延

  * 荷载信息的电磁波在通信线路上的传播速率取决于通信线路的介质材料

    

* 时延带宽积

  时延带宽积 = 传播时延 × 带宽

  链路的时延带宽积又称为以比特为单位的链路长度

  

* 往返时间RTT

  从发送方发送数据开始，到发送方收到来自接收方的确认，总共经历的时间

  有时往返时间还包括网络各中间结点的处理时延和排队时延以及转发数据时的发送时延

  有效数据率 = 数据长度 /（发送时间 + RTT）

  

* 利用率

  信道利用率：某信道有百分之几的时间是被利用的

  网络利用率：全网络的信道利用率的加权平均值

  D =  D0 / （1 - U）     D：网络当前时延，D0：网络空闲时的时延，U：利用率

  注意：

  * 信道或网络的利用率过高会产生非常大的时延

  * 空闲信道的利用率是0

    

（2）非性能指标：

* 费用
* 质量
* 标准化
* 可靠性
* 可扩展性和可升级性
* 易于管理和维护



（3）区别

* 性能指标是直接反映网络性能的，而非性能特征则不是网络所特有的指标

* 有时网络的非性能特征能够制约网络性能指标的实现

  

### 6.计算机网络体系结构

（1）协议

网络协议：

* 为进行网络中的数据交换而建立的规则、标准或约定
* 这些规则明确规定了所交换的数据的格式以及有关的同步问题
* 网络协议必须把所有的不利情况都考虑到，如果网络协议没有考虑一些不利的情况，当这些不利的情况出现时，协议就会失败

协议三要素：

* 语法

  数据与控制信息的结构或格式

* 语义

  需要发出何种控制信息，完成何种动作以及做出何种响应

* 同步（时序）

  事件实现顺序的详细说明

协议栈：由于计算机网络体系结构采用了分层结构，不论在主机还是路由器中的协议都有好几层，这一层一层的协议画起来就像堆栈的结构，因此就把这些协议层称为协议栈

（2）划分层次

分层的好处：

* 可以把庞大而复杂的问题转化为若干较小的局部问题，而这些较小的局部问题比较易于研究和处理

* 各层之间是独立的
* 灵活性好
* 结构上可分割开
* 易于实现和维护
* 能促进标准化工作

通常各层所要完成的功能主要为：

* 差错控制

* 流量控制

* 分段和重装

* 复用和分用

* 连接建立和释放

  

（3）体系结构

网络的体系结构：计算机网络的各层及其协议的集合

对等层：在网络体系结构中，通信双方实现同样功能的层

* 应用层

  * 体系结构中的最高层
  * 直接为用户的应用进程提供服务

  * 应用层协议：应用进程间通信和交互的规则

  * 应用层交互的数据单元称为报文

* 运输层

  * 负责向两个主机中的进程之间的通信提供数据传输服务

  * 运输层主要使用的协议：TCP，UDP

  * 复用、分用

    复用：多个应用层进程可同时使用下面运输层的服务

    分用：运输层把收到的信息分别交付上面应用层中的相应的进程

* 网络层

  * 负责为分组交换网上的不同主机提供通信服务，还有选择合适的路由

  * 无论在哪一层传输的数据单元，都可笼统地使用“分组”来表示

* 数据链路层

  * 在两个相邻结点之间传送数据
  * 数据链路层将网络层交下来的IP数据报组装成帧，在收到一个帧后，从中提取出数据部分，上交给网络层
  * 在链路上实现透明传输，差错检测

* 物理层

  * 物理层所传数据的单位是比特

* 物理层的任务就是透明地传输比特流，确定连接电缆的插头应当有多少根引脚以及各条引脚应如何连接

  * 解释比特代表的意思不是物理层的任务

  * 物理层要考虑用多大电压代表“1” 或 “0”，以及接收方如何识别出发送方所发送的比特

  * 传递信息所利用的一些物理媒体，如双绞线、同轴电缆、光缆、无线信道等，并不在物理层协议之内而是在物理层的下面

  

注意：五层协议的体系结构只是为介绍网络原理而设计的，实际应用还是TCP/IP四层体系结构



（4）实体、协议、服务

实体：任何可以发送或接受信息的硬件或软件进程

协议：控制两个对等实体（或多个实体）进行通信的规则的集合

协议数据单元：PDU，它是对等实体之间进行信息交换的数据单元

协议与服务：

* 在协议的控制下，两个对等实体间的通信使得本层能够向上一层提供服务
* 要实现本层协议，还需要使用下面一层多提供的服务

* 协议的实现保证了能够向上一层提供服务，使用本层服务的实体只能看见服务而无法看见下面的协议
* 协议是“水平的”，协议是控制对等实体之间通信的规则
* 服务是“垂直的”，服务是由下层向上层通过层间接口提供的
* 并非在一个层内完成的全部功能都称为服务，只有那些能被高一层实体“看得见”的功能才被称为“服务”

服务访问点：同一系统中相邻两层的实体进行交互（即交换信息）的地方



## 物理层

### 1.物理层的基本概念

（1）物理层的作用：

* 考虑怎样才能连接各种计算机的传输媒体上传输数据的比特流，而不是指具体的传输媒体
* 尽可能地屏蔽掉传输媒体和通信手段的差异，使物理层上面的数据链路层感觉不到这些差异
* 确定与传输媒体的接口有关的一些特性
* 传输方式的转换。计算机内部为并行传输，通信线路上为串行传输

注意：

* 物理层要考虑用多大电压代表“1”或“0”以及接收方如何识别出发送方所发送的比特
* 物理层要确定连接电缆的插头应该有多少根引脚以及各条引脚应如何连接
* 哪几个比特代表什么意思不是物理层要管的

（2）特性：

* 机械特性

  指明接口所用接线器的形状和尺寸、引脚数目和排列、固定和锁定装置等

* 电气特性

  指明在接口电缆的各条线上出现的电压的范围

* 功能特性

  指明某条线上出现的某一电平的电压的意义

* 过程特性

  指明对于不同功能的各种可能事件的出现顺序

注意：

* 传输媒体本身并不属于物理层的范围

* 规程与协议

  规程这个名词仅用于物理层，在其他层不用“规程”，而用“协议”

  在物理层，这两个词没有多大区别

  

### 2.数据通信的基础知识

#### 1.数据通信系统的模型

通信系统：

![截图录屏_选择区域_20200605105841](/home/garlic/Desktop/笔记/总结/基础/数据结构/picture/截图录屏_选择区域_20200605105841.png)

* 源系统

  源点

  发送器：调制器

* 传输系统

  传输线，网络系统

* 目的系统

  接收器：解调器

  终点

注意：

* 通信目的是传送消息，如语音、文字、图像、视频等
* 数据是运送消息的实体
* 信号分为模拟信号和数字信号
* 代表不同离散数值的基本波形成为码元
* 一个码元所携带的信息量是不固定的，是由调制方式和编码方式决定的

#### 2.有关信道的几个基本概念

（1）信道与电路

* 信道和电路并不等同
* 信道一般都是用来表示向某一个方向传送信息的媒体
* 一条通信电路往往包含一条发送信道和一条接收信道

（2）三种通信方式

* 单向通信（单工）

  只有一个方向的通信而没有反方向的交互

* 双向交替通信（半双工）

  通信的双方都可以发送信息，但不能同时发送（接受）

* 双向同时通信（双工）

  通信双方可以同时发送和接收信息

（3）基带信号

* 基带信号：来自信源的信号

* 基带信号往往包含包含有较多的低频成分，甚至有直流成分，而许多信道并不能传输这种低频分量或直流分量

* 因此必须对基带信号进行调制

（4）两类调制

* 基带调制

  仅对基带信号的波形进行变换，变换后的信号仍然是基带信号

  这种过程也成为编码

  * 常见编码

    ![微信图片_20200626101901](/home/garlic/Desktop/笔记/总结/基础/计算机网络/picture/微信图片_20200626101901.jpg)

  

* 带通调制

  需要使用载波进行调制，把基带信号的频率范围搬迁到较高的频段，并转换为模拟信号

  调制后的信号成为带通信号（仅在一段频率范围内能够通过信道）

  * 基本的带通调制方法

    ![微信图片_20200626102111](/home/garlic/Desktop/笔记/总结/基础/计算机网络/picture/微信图片_20200626102111.jpg)

#### 3.信道的极限容量

码元传输的速率越高，或信号传输的距离越远，或噪声干扰越大，或传输媒体质量越差，在接收端的波形的失真就越严重

（1）限制码元在信道上的传输速率的因素

* 信道能够通过的频率范围

  很多高频分量往往不能通过信道

  码间串扰

  在任何信道中，码元传输的速率是有上限的，传输速率超过此上限，就会出现严重的码间串扰的问题，使接收端对码元的判决（识别）成为不可能

* 信噪比

  信噪比：信号的平均功率和噪声的平均功率之比，单位dB

  信噪比= 10 log<sub>10</sub> (S/N)   (dB)

  

  注意：

  * 可以利用编码的方法让每个码元携带更多比特的信息量

  * 信噪比不可能做到任意大，信号的传输功率是受限的，并且任何电子设备的噪声不可能做到任意小

  * 对于频带宽带已确定的信道，信噪比也不能再提高，并且码元传输速率也达到了上限值

  * 在实际信道中，信号还要受到其他一些损伤，如各种脉冲干扰和在传输中产生的失真，等等。

  * 码元/秒 与 比特/秒

    不完全一样，在不同的编码情况下，码元与比特的对应关系不同

（2）香农公式与奈式准则

* 香农公式：

  * 极限传输速率C=W log<sub>2</sub> (1+S/N)  (bit/s)
  * W为信道的带宽，S为信道内传送信号的平均功率，N为信道内高斯噪声功率
  * 只要信息传输速率低于信道的极限信息传输速率，就一定存在某种办法来实现无差错的传输

* 奈式准则

  在假定的理想条件下，为了避免码间串扰，码元传输速率的上限值

  

#### 4.概念汇总

* 数据：运送消息的实体

* 信号：数据的电气的或电磁的表现

* 模拟数据：即连续数据，数据的变化是连续的

* 模拟信号：即连续信号，代表消息的参数的取值是连续的

* 基带信号：来自信源的信号，也就是基本频带信号

* 带通信号：经过载波调制后的信号，把基带信号的频率范围搬移到较高的频段以便在信道中传输

* 数字数据：即离散数据，数据的变化是不连续的

* 数字信号：即离散信号，代表消息的参数的取值是离散的

* 码元

  码是信号元素和字符之间的事先约定好的转换

  码元实际上就是码所包含的元素

  在简单的编码中，一个码元就是一个比特，在复杂的编码中，一个码元可以包含多个比特

* 串行传输

  数据在传输时是逐个比特按照时间顺序依次传输的

* 并行传输

  数据在传输时采用了n个并行的信道，在每个信道上，数据仍然是串行传输的

### 3.物理层下面的传输媒体

传输媒体就是数据传输系统中在发送器和接收器之间的物理通路

在导引型传输媒体中，电磁波被导引沿着固体媒体传播，而非导引型传输媒体就是指自由空间

（1）导引型传输媒体

* 双绞线
* 同轴电缆
* 光缆
* 架空明线（目前已很少使用）

（2）非导引型传输媒体

* 无线传输
* 短波通信（高频通信）
* 无线电微波通信
* 卫星通信
* 红外通信
* 激光通信

### 4.信道复用技术

许多用户通过复用技术就可以共同使用一个共享信道来进行通信，虽然复用要付出一定的代价，但如果复用的信道数量较大，总的来看在经济上还是合算的



（1）频分复用、时分复用和统计时分复用

* 频分复用

  所有用户在同样的时间占用不同的带宽资源

* 时分复用

  所有用户是在不同的时间占用同样的频带宽度

* 使用统计时分复用

  统计复用又称为异步时分复用，而普通的时分复用称为同步时分复用

注意：

* 使用频分复用，当复用的用户数增加时，复用后的信道的总宽带就跟着变宽

* 使用时分复用可能会造成线路资源的浪费



（2）波分复用

波分复用WDN就是光的频分复用

密集波分复用和稀疏波分复用



（3）码分复用

给每个站分配的码片序列不仅必须各不相同，并且还必须互相正交

发送时

* 把每个码元扩展为m个码片，m通常为64或128
* 如果要发送1，则发送它的m比特码片序列
* 如果要发送0，则发送该码片序列的反码

接受时

* 计算规格化内积
* 检测是哪个站发送了数据，是否为0
* 计算发送了什么数据，结果为1还是-1

注意：

* 码分多址CDMA
* 码分复用最初用于军事通信，发送的信号有很强的抗干扰能力，其频谱类似于白噪声，不易被敌人发现
* 由于各用户使用经过特殊挑选的不同码型，因此各用户之间不会造成干扰。
* CMDA有很强的抗干扰能力，可以提高通信的话音质量和数据的可靠性，减少干扰对通信的影响，增大通信系统的容量，降低手机的平均发射功率

注意：

* FDM：频分复用
* TDM：时分复用
* STDM：统计时分复用
* WDM：波分复用
* DWDM：密集波分复用
* CDMA：码分多址
* SONET：同步光纤网
* SDH：同步数字系列
* STM-1：第1级同步传递模块
* OC-48：光载波

### 5.宽带接入技术

宽带接入技术可分为有线宽带接入和无线宽带接入



（1）ADSL技术

ADSL用数字技术对现有的模拟电话用户线进行改造，使它能够承载宽带数字业务

* 可以利用现有电话网中的用户线，不需要重新布线

* 用户可以根据自己的情况使用不同速率的宽带接入（按宽带付费）

* 对用户线的质量有较高的要求

* 如果用户住宅距离电话交换局较远，或线路的噪声较大，那么宽带接入的速率就会适当的降低

  

（2）光纤同轴混合网（HFC网）

HFC网把原有线电视网中的同轴电缆主干部分改换为光纤

* 覆盖面广，并且带宽也很高，可以传送很高速率的数据
* 必须对现有单向传输的有线电缆进行改造，变为可双向通信的电缆
* 用户家需要增加一个机顶盒，用来观看电视和传送上行信号
* 为了解决信号传输时有衰减的问题，在有线电缆中每隔一定距离就要加入一个放大器，大量放大器的接入将使整个网络的可靠性下降



（3）FTTx技术

* x表示不同的光纤接入地点

* 光纤可传送的数据率很高，且通信质量最好，但大量用户使用光纤接入还需要较多的建设资金

* 光配线网ODN

* 无源光网络PON

  * EPON（以太网无源光网络）

    与现有以太网的兼容性好，并且成本低，扩展性强，管理方便

  * GPON（吉比特无源光网络）

    采用通用封装方法GEM，可承载多业务，对各种业务类型都能够提供服务质量保证，是很有潜力的带宽光纤接入技术

  



## 数据链路层

### 1.使用点对点信道的数据链路层

#### 1.数据链路和帧

* 链路：从一个结点到相邻节点的一段物理线路（有线或无线），而中间没有任何其他的交换节点

* 数据链路：把实现通信协议的硬件和软件加到链路上

  一般使用网络适配器来实现这些协议，一般的适配器都包括数据链路层和物理层这两层的功能

* 帧：数据链路层的协议数据单元

数据链路层把网络层交下来的数据构成帧发送到链路上，以及把接收到的帧中的数据取出并上交给网络层

#### 2.三个基本问题

（链路控制的功能）

三个基本问题：封装成帧，透明传输，差错检测

（1）封装成帧：

* 就是指一段数据前后分别添加首部和尾部
* 使用了帧定界符，接收端就可以判断收到的数据是否完整
* 当输入的是可打印的ASCII码组成的文本文件时，帧定界可以使用特殊的帧定界(非打印)

（2）透明传输：

* 无论什么样的比特组合的数据，都能够按照原样没有差错地通过这个数据链路层
* 当数据中恰好出现控制字符，数据链路层就会错误的“找到边界”，把剩下的数据丢弃
* 发送端的数据链路层在出现控制字符的前面插入一个转义字符，在接收端的数据链路层在把数据发往网络层之前删除这个转义字符
* 若数据中出现了转义字符，则在前面再插入一个转义字符

（3）差错检测：

CRC检验过程：

* 首先收发双方共同确定一个除数P，（n+1）位
* 发方在将要发送的数据M后添加n个0，经模2除法运算后，得到n位余数R，再将R拼接到M后发送出去
* 收方在接受到数据M后，将其进行模2除法运算，对余数进行判断

注意：

* 在传输过程中可能会产生比特差错

* 误码率BER，误码率与信噪比有很大关系

* 在数据链路层采用循环冗余检验CRC

* 帧检验序列FCS

* 在数据链路层，发送端帧检验序列FCS的生成和接收端的CRC校验都是用硬件完成的，处理很迅速

* 在数据链路层使用CRC校验只能做到对帧的无差错接收

* 出现传输错误：

  帧丢失，帧重复，帧失序

* 在通信质量良好的有线传输链路，数据链路层协议不使用确认和重传机制

* 对于通信质量较差的无线传输链路，数据链路层协议使用确认和重传机制，对上层提供可靠的传输服务

### 2.点对点协议PPP

高级数据链路控制HDLC

#### 1.PPP协议的特点

（1）PPP协议应满足的需求：

* 简单
* 封装成帧
* 透明性
* 多种网络层协议
* 多种类型链路
* 差错检测
* 检测连接状态
* 最大传送单元
* 网络层地址协商
* 数据压缩协商

（2）PPP协议的组成：

* 一个将IP数据报封装到串行链路的方法
* 一个用来建立、配置和测试数据链路连接的链路控制协议LCP
* 一套网络控制协议NCP，其中每个协议支持不同的网络层协议

注意：

* 在TCP/IP协议族中，可靠传输由运输层的TCP协议负责，因此数据链路层的PPP协议不需要进行纠错，不需要设置序号，也不需要进行流量控制。
* PPP协议不支持多点线路，只支持点对点的链路通信
* PPP只支持全双工链路

#### 2.PPP协议的帧格式

（1）各字段的意义

![微信图片_20200626113501](/home/garlic/Desktop/笔记/总结/基础/计算机网络/picture/微信图片_20200626113501.jpg)

* 标志字段

  规定为0x7E，表示一个帧的开始或结束

* 地址字段

* 控制字段

* 协议字段

  0x0021：信息字段为IP数据报

  0xC021：信息字段为LCP的数据

  0x8021：网络层的控制数据

* 信息字段

  长度可变，不超过1500字节

* 校验字段

  使用CRC的帧检验序列FCS

（2）字节填充

当PPP协议使用异步传输时，把转义符定义为0x7D，并使用字节填充

数据字段中出现

* 0x7E ，使用转义字符0x7D，并转变成（0x7E，0x5D）

* 0x7D，再添加0x7D，并转变成（0x7D，0x5D）

* ASCII码控制字符，使用转义字符0x7D，并转变2个字节

  比如0x03，转变成（0x7D，0x23）



（3）零比特填充

PPP协议用在SONET/SDH链路时，使用同步传输（一连串的比特传输），而不是异步传输（逐个字符的传送）

当PPP协议使用同步传输时

发送方：数据字段中只要出现5个1,就立即填入一个0

接收方：接受到一个帧时，找到标志字段F确定边界，再进行还原

#### 3.PPP协议的工作状态

讨论PPP链路一开始是怎样被初始化的，用户获得ip地址，进行通信，释放连接

![TIM图片20200427104901](/home/garlic/Desktop/笔记/总结/基础/计算机网络/picture/TIM图片20200427104901.jpg)

注意：

* PPP协议已经不是纯粹的数据链路层的协议，它还包含了物理层和网络层的内容

### 3.使用广播信道的数据链路层

#### 1.局域网的数据链路层

（1）局域网的主要特点：

* 网络为一个单位所拥有，且地理范围和站点数目均有限

（2）局域网的主要优点：

* 具有广播功能，从一个站点可很方便地访问全网
* 便于系统的扩展和逐渐演变，各设备的位置可灵活调整和改变
* 提高了系统的可靠性、可用性和生存性

（3）局域网的分类：

* 星形网
* 环形网
* 总线网

注意：

* 现在以太网几乎成为了局域网的同义词
* 局域网的工作层次跨越了数据链路层和物理层

（4）共享信道的划分：

* 静态划分信道

  使用频分复用，时分复用等等

  用户分配到了信道就不会与其他用户发生冲突

  但这种划分方法代价较高，不适合局域网

* 动态媒体接入控制

  信道并非在用户通信时固定分配给用户

  * 随机接入

    所有用户可随机地发送信息，若同一时刻发送会产生碰撞

    必须有解决碰撞的网络协议

  * 受控接入

    不能随机的发送信息而必须服从一定的控制

    轮询

    受控接入目前在局域网中使用的较少

（5）以太网是什么？与局域网的区别？

* 以太网是美国施乐公司的PARC与1975年研制成功的，那时的以太网是一种基带总线局域网，以曾经在历史上表示传播电磁波的以太来命名。

* 802.3局域网对以太网标准中的帧格式做了很小的一点变动，但允许基于这两种标准的硬件实现可以在同一个局域网上互操作。

* 以太网的两个标准DIX Ethernet  V2与IEEE的802.3标准只有很小的差别，因此很多人也常把802.3局域网简称为“以太网”。

* 严格来说，以太网应当是符合DIX Ethernet  V2标准的局域网。

（6）以太网的两个标准：

局域网的数据链路层被拆成两个子层

* 逻辑链路控制LLC
* 媒体接入控制MAC

现在逻辑链路控制子层LLC的作用已经消失了，很多厂商生产的适配器上就仅装有MAC协议

（7）适配器的作用：

计算机与外界局域网的连接是通过通信适配器进行的。

适配器本来是主机箱中的一块网络接口板，又称网络接口卡或网卡，但现在计算机主板已经嵌入了这种适配器

![TIM图片20200427115109](/home/garlic/Desktop/笔记/总结/基础/计算机网络/picture/TIM图片20200427115109.jpg)

注意：

* 适配器实现的功能包含了数据链路层及物理层这两个层次的功能
* 路由器通过适配器连接到局域网
* 适配器在接收和发送各种帧时，不使用计算机的CPU。这时CPU可以处理其他任务
* 适配器具有过滤功能
* 适配器收到有差错的帧时，直接丢弃
* 适配器收到正确的帧时，使用中断来通知计算机，并交付给网络层

#### 2.CSMA/CD协议

（1）总线

​	总线的特点

* 当计算机发送数据时，总线上的所有计算机都能检测到这个数据，这就是广播通信

* 为了能在总线上实现一对一通信，可以使每一台计算机的适配器拥有一个与其他适配器都不同的地址

（2）两种措施

​	为了通信简单，以太网采用了两种措施：

* 采用无连接方式

  适配器对发送的数据帧不进行编码，也不要求对方发回确认

  以太网提供的服务是尽最大努力的交付

  对有差错帧是否需要重传则由高层来决定

* 以太网发送数据都使用曼彻斯特编码的信号

  使用二进制基带信号，当出现长串的0或1时，接受端就无法从收到的比特流中提取位同步信号

  曼彻斯特编码的每个码元正中间都会出现一次电压的转换，有利于同步信号的提取

  但它所占用的频带宽度比原始的基带信号增加了一倍

（3）CSMA/CD协议

​	CSMA/CD协议的要点：

* 多点接入

  说明这是总线型网络

  协议的实质是载波监听和碰撞检测

* 载波监听

  使用电子技术检测总线上有没有其他计算机也在发送

  不管在发送前，还是发送中，每个站都必须不停的检测信道

* 碰撞检测

  边发送边监听

  适配器边发送数据边检测信道上的信号电压的变化情况

注意：

* 电磁波在总线上总是以有限的速率传播的

* 电磁波在1km电缆的传播时延约为5us

* 在局域网的分析中，常把总线上的单程端到端传播的时延记为τ，发送数据帧后至多经过时间2τ就可以知道所发送的数据帧是否遭受了碰撞

* 以太网的端到端往返时间2τ称为争用期，争用期又称为碰撞窗口

* 在使用CSMA/CD协议时，一个站不可能同时进行发送和接收（但必须边发送边监听信道），因此使用该协议的以太网只能进行半双工通信

（4）截断二进制指数退避算法

​	以太网使用截断二进制指数退避算法来确定碰撞后重传的时机

* 这种算法让发生碰撞的站在停止发送数据后不是等待信道变空闲后就立即再发送数据，而是推迟一个随机的时间

* 协议规定了基本的退避时间为争用期为2τ，具体的争用期时间是51.2us

* 从离散的整数集合[0，1...，(2<sup>k</sup> - 1)]中随机取出一个数，记为r，重传应推后的时间就是r倍的争用期

  k = Min[重传次数，10]

* 当重传达16次仍不能成功，则丢弃该帧，并向高层报告

注意：

* 适配器每发送一个新的帧，就要执行一次CSMA/CD算法，适配器对过去发生过的碰撞并无记忆功能

* 以太网规定了一个最短帧长64字节，如果发送的数据非常少，那么必须加入一些填充字节

* 如果在争用期（共发送了64字节）没有发生碰撞，那么后续的数据就一定不会发生冲突

* 凡长度小于64字节的帧都是由于冲突而异常中止的无效帧

* 强化碰撞

  一旦发生碰撞，除了立即停止发送数据外，还要继续发送32比特或48比特的人为干扰信号，以便让所有用户都知道现在已经发生了碰撞

* 以太网规定的帧间最小间隔为9.6us

![微信图片_20200622100141](/home/garlic/Desktop/笔记/总结/基础/计算机网络/picture/微信图片_20200622100141.jpg)

#### 3.使用集线器的星型拓扑

（1）星形

* 以太网采用星形拓扑，在星形的中心增加了可靠性非常高的设备，叫做集线器

* 双绞线以太网总是和集线器配合使用，每个站需要用两对无屏蔽双绞线（放在一根电缆内），分别用于发送和接收，双绞线的两端使用RJ-45插头

* 传统以太网使用的粗缆和细缆已经从市场上消失了

（2）10BASE-

* 10BASE-T

  * 1990年制定出星形以太网10BASE-T标准802.3i

  * 10代表10Mbit/s的数据率，BASE表示连接线上的信号是基带信号，T表示双绞线

  * 10BASE-T以太网的通信距离稍短，每个站到集线器的距离不超过100m

* 10BASE-F

  * IEEE 802.3标准还可使用光纤作为传输媒体，相应的标准是10BASE-F系列，F代表光纤
  * 它主要用作集线器之间的远程连接

（3）集线器的特点

* 使用集线器的以太网在逻辑上仍然是一个总线网，各站共享逻辑上的总线，使用的还是MSMA/CD协议（各站中的适配器执行CSMA/CD协议），同一时刻至多只允许一个站发送数据

* 集线器有许多接口，每个接口使用RJ-45插头，很像一个多接口的转发器

  集线器的接口又称端口，运输层的软件端口和集线器的硬件端口是两回事

* 集线器工作在物理层，它的每个接口仅仅简单地转发比特，收到1转发1,收到0转发0,不进行碰撞检测

  若两个接口同时有信号输入（即发生碰撞），那么所有的接口都收不到正确的帧

* 集线器采用了专门的芯片，进行自适应串音回波抵消

* 集线器基本上是多接口的转发器，不能缓存帧

#### 4.以太网的信道利用率

（1）信道利用率

* 假定发送帧需要的时间是T<sub>0</sub> ，成功发送最后一个帧需要占用信道的时间是T<sub>0</sub> + τ

  要提高以太网的信道利用率，就必须减少τ 与 T<sub>0</sub> 之比

* 定义a ，a = τ  / T<sub>0</sub> 

  当a->0时，表示只要一发生碰撞，就立即可以检测出来，并立即停止发送

  当数据率一定时，以太网的连线的长度受到限制，同时以太网的帧长不能太短

（2）理想化情况

一种理想化的情况：

* 假设以太网上的各站发送数据都不会产生碰撞（这显然不是CSMA/CD），并且能非常有效地利用网络的传输资源

  发送一帧占用线路的时间是T<sub>0</sub> + τ ，而帧本身的发送时间是T<sub>0</sub> 

* 极限信道利用率S<sub>max</sub> = T<sub>0</sub> / T<sub>0</sub> + τ = 1 / (1+a)

  当参数远小于1才能得到尽可能高的极限信道利用率

#### 5.以太网的MAC层

（1）MAC层的硬件地址

* 在局域网中，硬件地址又称为物理地址或MAC地址（因为这种地址用在MAC帧中），是48位，固化在适配器的ROM中的地址

  

* 如果连接在局域网上的主机或路由器安装有多个适配器，那么这样的主机或路由器就有多个“地址”，这48位“地址”应当是某个接口的标识符

* 路由器如果同时连接多个网络，那么它需要多个适配器和硬件地址

  

* IEEE 802标准规定MAC地址字段可采用6字节（48位）或2字节（16位）这两种中的一种

* 由于6字节的地址字段可使全世界所有的局域网适配器都具有不同的地址，因此现在的局域网适配器实际上使用的都是6字节MAC地址

  

* IEEE的注册管理机构RA负责分配地址字段的6个字节的前三个，世界上凡是生产局域网适配器的厂家都必须向IEEE购买这三个字节构成的这个号，这个号的正式名称是组织唯一标识符OUI

* 地址字段的后三个字节由厂家自行指派，成为扩展标识符

  

* 一个地址块可以生成2<sup>24</sup> 个不同的地址，得到的地址称为EUI-48，这里的EUI表示扩展的唯一标识符，EUI-48可用于硬件地址也可用于软件接口

  

* IEEE规定地址字段的第一个字节的最低位为I/G位，I/G表示Individual/Group，当I/G位为0时，地址字段表示一个单个站地址，当I/G位为1时表示组地址，用来进行多播

* IEEE把地址字段第一字节的最低第二位规定为G/L位，表示Global/Local，当G/L位为0时是全球管理，厂商向IEEE购买的OUI都属于全球管理，当为1时是本地管理，用户可任意分配网络上的地址



（2）三种帧

* 单播帧（一对一），即收到的帧的MAC地址与本站的硬件地址相同
* 广播帧（一对全体），即发送给本局域网上所有站点的帧（全1地址）
* 多播帧（一对多），即发送给本局域网上一部分站点的帧

所有的适配器都至少应当识别前两种帧

（3）混杂方式

* 以太网适配器还可以设置为一种特殊的工作方式，即混杂方式

* 工作在混杂方式的适配器只要“听到”有帧在以太网上传输就都悄悄地接收下来，而不管这些帧是发往哪个站

* 这种方式其实是“窃听”其他站点的通信而并不中断其他站点的通信

* 但混杂方式有时却非常有用，网络维护和管理人员需要用这种方式来监视和分析以太网上的流量，以便找出提高网络性能的网络适配器

* 嗅探器就使用了设置为混杂方式的网络适配器

（4）MAC帧格式

常用的以太网MAC帧格式有两种标准，一种是DIX Ethernet V2标准（以太网V2标准），另一种是IEEE的802.3标准

![微信图片_20200623091106](/home/garlic/Desktop/笔记/总结/基础/计算机网络/picture/微信图片_20200623091106.jpg)

* 类型

  当类型字段的值是0x0800时，表示上层使用的是IP数据报

  当类型字段的值为0x8137,表示帧是由Novell IPX发过来的

* 数据

  数据字段的46字节：最小长度64字节减去18字节的首部和尾部

* FCS

  MAC帧的FCS字段的检验范围不包括前同步码和帧开始定界符

* 同步

  * 当一个站在刚开始接收MAC帧时，适配器的时钟尚未与到达的比特流同步，会造成第一个MAC成为无用帧

  * 从MAC子层向下传到物理层时还要在帧前面插入8个字节（由硬件生成）

  * 第一个字段是7个前同步码（1和0交替），让适配器在接收MAC帧时能迅速调整其时钟频率

  * 第二个字段是帧开始定界符，定义为10101011,前六位的作用与前同步码一样，最后两个连续的1告诉适配器注意查收MAC帧

  * 在使用SONET/SDH进行同步传输则不需要前同步码，因为在同步传输时收发双方始终保持位同步

注意：

* 以太网V2的MAC帧格式中首部没有帧长度字段，判断数据长度的方法：发送方把一个以太网帧发送完毕后，就不再发送其他码元了（既不发送1,也不发送0），发送方网络适配器的接口上的电压也就不再变化，以太网帧的结束位置：电压不变的位置往前四个字节（FCS）
* 当数据字段小于46个字节时，进行填充后，上层必须能识别有效数据，使用IP协议时，IP首部的“总长度”+填充字段的长度=MAC帧数据字段的长度
* 以太网不需要使用帧结束定界符，也不需要使用字节插入来保证透明传输

（5）无效MAC帧

​	（IEEE802.3标准规定）

* 帧的长度不是整数个字节
* 用收到的帧检验序列FCS查出有差错
* 收到的帧的MAC客户数据字段的长度不在46～1518之间

对于检查出的无效MAC帧就简单丢弃，以太网不负责重传丢弃的帧



（6）IEEE802.3与以太网V2区别

* IEEE802.3规定的MAC帧的第三个字段是“长度/类型”

  * 大于0x0600时，表示类型，与以太网V2一样
  * 小于0x0600时，表示长度，MAC帧的数据长度，由于以太网使用曼彻斯特编码，长度字段并无意义

* “长度/类型”字段值小于0x0600时，数据字段装上LLC子层的LLC帧

  由于现在广泛使用的局域网只有以太网，因此LLC帧已经失去了原来的意义

  现在市场上流行的都是以太网V2的MAC帧，但也常被称为IEEE802.3标准

### 4.扩展的以太网

扩展的以太网在网络层看起来仍然是一个网络

#### 1.在物理层扩展以太网

以太网上的主机之间的距离不能太远

在过去常使用工作在物理层的转发器来扩展以太网的地理雾盖范围

现在常使用光纤（一对）和一对光纤调制解调器来扩展主机和集线器之间的距离

光纤调制解调器的作用就是进行光信号和电信号的转换

![微信图片_20200623105450](/home/garlic/Desktop/笔记/总结/基础/计算机网络/picture/微信图片_20200623105450.jpg)

好处：

* 使这个学院不同系的以太网上的计算机能够进行跨系的通信
* 扩大了以太网的覆盖范围

缺点：

* 每个系的以太网是一个独立的碰撞域，在任一时刻，在每一个碰撞域中只能有一个站在发送数据
* 若每个系的以太网的吞吐量为10Mbit/s，(a)中最大为30Mbit/s，(b)中为10Mbit/s，某个系的两个站在通信时的数据会通过所有的集线器进行转发，使得其他系内部不能通信
* 如果不同的系使用不同的以太网技术，那么不可能使用集线器将它们互连起来
* 一个系使用10Mbit/s的适配器，另外两个使用10/100Mbit/s的适配器，那么用集线器连接起来后，大家只能工作在10Mbit/s

#### 2.在数据链路层扩展以太网（以太网交换机）

在数据链路层扩展时，最初常用的是网桥

1990年问世的交换式集线器也城以太网交换机，很快就淘汰了网桥

（1）以太网交换机的特点

* 以太网交换机实质上就是一个多接口的网桥

* 以太网交换机的每个接口都直接与一个单台主机或另一个以太网交换机相连，一般是全双工方式

* 以太网交换机具有并行性，能同时连通多对接口，使多对主机能同时通信，而网桥只能一次分析和转发一个帧

* 相互通信的主机都是独占传输媒体，无碰撞地传输数据

* 以太网交换机的接口还有存储器，当接口繁忙时，可以将帧暂存

* 以太网交换机是一种即插即用设备，其内部的帧交换表是通过自学习算法自动建立起来的

* 对于拥有10个接口的交换机的总容量则为这几个接口之和，传统的是共享

* 从共享总线以太网转到交换式以太网时，所有的接入设备的软件，硬件、适配器等都不需要作任何改动

* 以太网交换机一般具有多种速率的接口

* 有些以太网交换机采用直通的交换方式，在接收数据帧的同时，就立即按数据帧的目的MAC地址决定该帧的转发接口

  在这种交换机的内部采用基于硬件的交叉矩阵，交换时延就非常小

  缺点是它不检查差错就直接将帧转发出去，因此有可能也将一些无效帧转发给其他的站

（2）以太网交换机的自学习功能

![微信图片_20200623112546](/home/garlic/Desktop/笔记/总结/基础/计算机网络/picture/微信图片_20200623112546.jpg)

* 考虑到有时候可能要在交换机的接口更换主机，或者主机要更换其网络适配器，这就需要更改交换表中的项目，因此，交换表中每个项目都设有一定的有效时间，过期的项目就自动被删除
* 有时为了增加网络的可靠性，在使用以太网交换机组网时，往往会增加一些冗余的链路，在这种情况下，自学习过程就可能导致以太网帧在某个环路中无限的兜圈子
* 为了解决这种兜圈子问题，IEEE的802.1D标准制定了一个生成树协议STP
* 其要点就是不改变网络的实际拓扑，但在逻辑上则切断某些链路，使得从一台主机到所有其他主机的路径是无环路的树状结构，从而消除了兜圈子现象

**交换机的MAC地址学习过程**

**交换机对数据的转发与过滤**

（3）从总线以太网到星形以太网

* 总线以太网使用CSMA/CD协议，以半双工方式工作
* 但以太网交换机不使用共享总线，没有碰撞问题，因此不使用CSMA/CD协议，而是以全双工方式工作
* 既然连以太网的重要协议CSMA/CD都不使用了（相关的争用期也没有了），为什么还叫做以太网呢
* 原因是它的帧结构未改变，仍然采用以太网的帧结构

#### 3.虚拟局域网VLAN

虚拟局域网VLAN是由一些局域网网段构成的与物理位置无关的逻辑组，而这些网段具有某些共同需求，每个VLAN的帧都有一个明确的标识符，指明发送这个帧的计算机属于哪个VLAN

虚拟局域网其实只是局域网给用户提供的一种服务，并不是一种新型局域网

每个VLAN的计算机都可处在不同的局域网中

每个虚拟局域网上的每个站都可以收到同一个虚拟局域网上的其他成员所发出的广播，以太网交换机不向虚拟局域网以外的计算机传送其中的广播信息

![微信图片_20200623115346](/home/garlic/Desktop/笔记/总结/基础/计算机网络/picture/微信图片_20200623115346.jpg)

VLAN标记的前两个字节总是设置为0x8100，被称为IEEE 802.1Q标记类型

CFI：规范格式指示符

VID：是该虚拟局域网VLAN标识符（VLAN ID），它唯一的标志了这个以太网属于哪一个VLAN

由于VLAN的以太网帧的首部增加了4个字节，因此以太网的最大帧长从原来的1518字节增加到1522字节

### 5.高速以太网

#### 1.100BASE-T以太网

100BASE-T是在双绞线上传送100Mbit/s的基带信号的星形拓扑以太网，仍使用IEEE 802.3的CSMA/CD协议，又称快速以太网

1995年IEEE已把100BASE-T的快速以太网定为正式标准，其代号为IEEE 802.3u，是对IEEE802.3标准的补充

IEEE 802.3的标准未包括对同轴电缆的支持，从细缆以太网升级到快速以太网的用户必须重新布线

![微信图片_20200624154114](/home/garlic/Desktop/笔记/总结/基础/计算机网络/picture/微信图片_20200624154114.jpg)

为了保持参数a不变，把网络电缆长度减少

#### 2.吉比特以太网

![微信图片_20200624155139](/home/garlic/Desktop/笔记/总结/基础/计算机网络/picture/微信图片_20200624155139.jpg)

![微信图片_20200624155148](/home/garlic/Desktop/笔记/总结/基础/计算机网络/picture/微信图片_20200624155148.jpg)

当吉比特以太网工作在半双工方式时，为了保持a为较小的值，采用“载波延伸”，使最短帧长仍为64字节，将争用期增大为512字节

凡MAC帧长不足512字节时，使用一些特殊字符填充在帧的后面

分组突发：当很多短帧要发送时，第一个短帧采用“载波延伸”，随后的短帧可一个接一个的发送，它们之间只需保留帧间的最小间隔即可，这样就形成一串分组的突发，直到达到1500字节或稍多一些为止

当吉比特以太网工作在全双工方式时，不使用载波延伸和分组突发

#### 3.10吉比特以太网（10GE）和更快的以太网

10GE并非把吉比特以太网的速率简单地提高到10倍

10吉比特就是10×10<sup>9</sup> 比特

10GE的帧格式与10Mbit/s，100Mbit/s和1Gbit/s以太网的帧格式完全相同，并保留了802.3标准规定的以太网最小帧长和最大帧长

10GE只工作在全双工方式，不存在争用问题，不使用CSMA/CD协议，这使得10GE的传输距离大大提高了（因为不再受必须进行碰撞检测的限制）

![微信图片_20200624161055](/home/garlic/Desktop/笔记/总结/基础/计算机网络/picture/微信图片_20200624161055.jpg)



40/100GE只工作在全双工的传输方式，保持了以太网帧格式并保留了802.3标准规定的以太网最小帧长和最大帧长

100GE在使用单模光纤传输时，仍然可以达到40km的传输距离，但这需要波分复用

![微信图片_20200624161103](/home/garlic/Desktop/笔记/总结/基础/计算机网络/picture/微信图片_20200624161103.jpg)

以太网从10Mbit/s到10Gbit/s甚至到100Gbit/s的演进，证明以太网是

* 可扩展的（速率从10Mbit/s到100Gbit/s）
* 灵活的（多媒体、全/半双工、共享/交换）
* 易于安装
* 稳健性好

#### 4.使用以太网进行宽带接入

以太网接入的一个重要特点是它可以提供双向的宽带通信，并且可以根据用户对宽带的需求灵活的进行带宽升级

当城域网和广域网都采用吉比特以太网或10吉比特以太网时，采用以太网接入可以实现端到端的以太网传输，中间不需要再进行帧格式的转换

在以太网的帧格式标准中，在地址字段部分并没有用户名字段，也没有密码，于是有人提出把PPP协议中的PPP帧再封装到以太网中进行传输，这就是PPPoE（在以太网上运行PPP）

当用户利用ADSL进行宽带上网时，用户个人电脑发送的以太网帧到了家里的ADSL调制解调器后，就转换成为ADSL使用的PPP帧，在用户家中的墙上是通过电话使用的RJ-11插口，用普通的电话线传送PPP帧，这种上网方式不能称为以太网上网，而是利用电话线宽带接入到互联网

## 网络层

### 1.网络层提供的两种服务

注意：

* 网络层向上只提供简单灵活的、无连接的、尽最大努力交付的数据报服务

* 网络在发送分组时不需要先建立连接，每一个分组独立发送，与其前后的分组无关

* 网络层不提供服务质量承诺

![image-20200315095831655](/home/qzj/.config/Typora/typora-user-images/image-20200315095831655.png)





### 2.网际协议IP

![image-20200315100157433](/home/qzj/.config/Typora/typora-user-images/image-20200315100157433.png)

RARP协议现已经被淘汰不使用了



#### 1.虚拟互联网络

中间设备：

* 物理层：转发器
* 数据链路层：网桥或桥接器
* 网络层：路由器
* 网络层以上：网关

注意：

* 当中间设备是转发器或网桥时，仅仅是把一个网络扩大了

* 网关由于比较复杂，目前使用得比较少

* 网络互连是指用路由器进行网络互连和路由选择

* 直接交付和间接交付



#### 2.分类的IP地址

IP地址的编址方法共经过了三个历史阶段：

* 分类的IP地址
* 子网的划分
* 构成超网

```
IP地址::={<网络号>,<主机号>}
```

![image-20200315102215486](/home/qzj/.config/Typora/typora-user-images/image-20200315102215486.png)

注意：

* IP地址现在由互联网名字和数字分配机构ICANN进行分配

* IP地址不仅仅指明一台主机，还指明了主机所连接到的网络

* 点分十进制记法



A类地址：

* 网络号全0：本网络
* 网络号为127：环回测试
* 主机号全0：主机所连接到的网络
* 主机号全1：该网络上所有的主机
* A类地址空间有2<sup>31</sup> 个地址，占整个IP地址空间的50%

B类地址：

* 网络地址为128.0.0.0是不指派的，最小的网络地址为128.1.0.0
* B类地址空间有2<sup>30</sup> ，占整个IP地址空间的25%

C类地址：

* 网络地址为192.0.0.0是不指派的，最小的网络地址为192.0.1.0
* C类地址空间有2<sup>31</sup> ，占整个IP地址空间的12.5%



![image-20200315104249774](/home/qzj/.config/Typora/typora-user-images/image-20200315104249774.png)



IP地址的特点：

* 每一个IP地址都由网络号和主机号组成
  * 分配IP地址只分配网络号，主机号由得到该网络号的单位自行分配
  * 路由器仅根据目的主机所连接的网络号来转发分组
* IP地址是标志一台主机（或路由器）和一条链路的接口
  * 多归属主机
* 一个网络是指具有相同网络号的主机的集合
* 在IP地址中，所有分配到网络号的网络都是平等的

注意：

* 网桥只能有一个网络号

* 路由器的每个接口都有一个不同网络号的IP地址

* 当两个路由器直接相连时，可分配也可以不分配IP地址

  * 无编号网络或无名网络

  

#### 3.IP地址与硬件地址

物理地址是数据链路层和物理层使用的地址，而IP地址是网络层和以上各层使用的地址，是一种逻辑地址

注意：

* 在IP层抽象的互联网上只能看到IP数据报

* 路由器只根据目的站的IP地址的网络号进行路由选择

* 在局域网的链路层，只能看见MAC帧

  在数据链路层要丢弃原来的MAC帧的首部和尾部，在转发时，在数据链路层，要重新添加上MAC帧的首部和尾部



#### 4.地址解析协议ARP

用途：从网络层使用的IP地址，解析出在数据链路层使用的硬件地址

ARP协议的要点：

* 在主机ARP高速缓存中存放一个从IP地址到硬件地址的映射表，并且这个映射表还经常动态更新（更新或超时删除）

* 每台主机都设有一个ARP高速缓存，里面有本局域网上的各主机和路由器的IP地址到硬件地址的映射表

当A向本局域网上的B发送IP数据报：

* A先在其ARP高速缓存中查看有无主机B的IP地址，若有，查出硬件地址
* 若无，ARP进程在本局域网上广播发送一个ARP请求分组
* 在本局域网上的所有主机上运行的ARP进程都接受到该请求分组
* 主机B收下这个请求分组，并向主机A发送响应分组
* 主机A收到响应分组后，就在ARP高速缓存中写入主机B的IP地址到硬件地址的映射

注意：

* ARP请求分组是广播发送，ARP响应分组是普通的单播
* 当主机B收到A的请求分组时，就把A的地址映射写入自己的ARP高速缓存中
* 每个地址映射都设置生存时间，超过生存时间的项目就删除
* ARP解决的是同一个局域网上的主机或路由器的地址映射问题
* IP地址到硬件地址的解析是自动进行的
* 不再使用RARP的原因是DHCP协议已经包含了RARP协议的功能









#### 5.IP数据报的格式



首部中固定部分的字段：

* 版本

  IPv4，IPv6

  通信双方使用的IP协议的版本必须一致

* 首部长度

  首部长度所表示的单位是4字节

  此字段的最小值是0101，最大值是60字节

  IP首部长度不知4字节的整数倍时，需要填充

* 区分服务

  在一般情况下，不使用这个字段

* 总长度

  首部和数据之和的长度，单位为字节

  超过MTU时需要分片，这里的总长度是每一分片的首部长度和数据长度的总和

* 标识

  每产生一个数据报，计数器就加1，并将此值赋给标识字段

  相同标识字段的值能使分片后的数据报片重装为原来的数据报

* 标志

  最低位MF，MF=1表示后面还有分片，MF=0表示已是数据报片的最后一个

  中间一位DF，DF=0表示不能分片

* 片偏移

  分片后，某片在原分组中的相对位置

  片偏移以8字节为偏移单位

  ![image-20200322081656422](/home/qzj/.config/Typora/typora-user-images/image-20200322081656422.png)

  ![image-20200322081847846](/home/qzj/.config/Typora/typora-user-images/image-20200322081847846.png)

* 生存时间TTL

  表明数据报在网络中的寿命，目的是防止无法交付的数据报无限制地在互联网中兜圈子，因而白白消耗网络资源

  后来TTL字段的功能改为“跳数限制”，单位是跳数，不再是秒

* 协议

  此数据报使用何种协议，以便目的主机的IP层知道将数据部分上交给哪个协议进行处理

  ![image-20200322082523758](/home/qzj/.config/Typora/typora-user-images/image-20200322082523758.png)

* 首部检验和

  只检验首部，不包括数据部分

  每进过一个路由器，都要重新计算一下首部检验和

  ![image-20200322082804211](/home/qzj/.config/Typora/typora-user-images/image-20200322082804211.png)

* 源地址

  占32位

* 目的地址

  占32位

IP数据报首部的可变部分：

* 可变部分的选项很少被使





#### 6.IP层转发分组的流程

在路由表中，每条路由最主要的两条信息：

（目的网络地址，下一跳地址）

![image-20200323114119059](/home/qzj/.config/Typora/typora-user-images/image-20200323114119059.png)

注意：

* 特定主机路由，人为
* 默认路由（0.0.0.0）
* 当路由器收到一个待转发的数据报，从路由表中得出下一跳路由IP后，不是将这个地址填入IP数据报，而是，交给数据链路层的网络接口软件
* 路由表并没有给分组指明到某个网络的完整路径

能不能在路由表中不使用IP地址，而直接使用硬件地址？

分组转发算法：

![image-20200323114316751](/home/qzj/.config/Typora/typora-user-images/image-20200323114316751.png)



### 3.划分子网和构造超网

#### 1.划分子网

早期IP地址设计不合理之处：

* IP地址空间的利用率有时很低
* 给每一个物理网络分配一个网络号会使路由表变得太大
* 两级IP地址不够灵活

划分子网的基本思路：

* 单位内部自行划分子网，这个单位对外表现为一个网络

* ```
  IP地址::={<网络号>，<子网号>，<主机号>}    
  ```

* 发送IP数据报时，仍按照目的网络号，路由器按照目的网络号和子网号找到目的子网

子网掩码：

* 两级IP的网络号 + 子网号

* 不管子网有没有划分子网，只要把子网掩码和IP地址进行逐位与运算，就立即得出网络地址来

* 所有网络都必须使用子网掩码，在路由表中也必须有子网掩码一栏

  不划分子网，使用默认子网掩码，其中1的位置与IP地址中网络号字段相对应

* 计算子网数和范围


注意：

* 划分子网增加了灵活性，但却减少了能够连接在网络上的主机数
* 同样的IP地址和不同的子网掩码可以得出相同的网络地址





#### 2.使用子网时分组的转发

划分子网后，路由表必须包含的内容：

​	目的网络地址，子网掩码，下一跳地址

![image-20200323115756748](/home/qzj/.config/Typora/typora-user-images/image-20200323115756748.png)





#### 3.无分类编址CIDR（构造超网）

变长子网掩码

无分类域间路由选择

CIDR的两个特点：

* CIDR消除了传统的A类，B类，C类地址以及划分子网的概念

  IP地址 :: = {<网络前缀>，<主机号>}

  斜线记法

* CIDR把网络前缀都相同的连续IP地址组成一个“CIDR地址块”

注意：

* CIDR使用32位地址掩码，也称子网掩码，斜线后的数字为1的个数
* "CIDR不使用子网"是指CIDR并没有在32位地址中指明若干位作为子网字段
* 在路由表中利用CIDR地址块来查找目的网络，这种聚合称为路由聚合
* CIDR还可用*表示



在查找路由表时可能会得到不止一个匹配结果

* 应当从匹配结果中选取具有最长网络前缀的路由（最长前缀匹配）
* 因为网络前缀越长，地址块越小，路由就越具体



使用二叉线索查找路由表

当路由表的项目数很大时，怎样设法减少路由表的查找时间是一个非常重要的问题

在路由表中必须使用很好的数据结构和使用先进的快速查找算法

![image-20200323122538148](/home/qzj/.config/Typora/typora-user-images/image-20200323122538148.png)






### 4.网际控制报文协议ICMP

ICMP允许主机或路由器报告差错情况和提供有关异常情况的报告

![image-20200318111215968](/home/qzj/.config/Typora/typora-user-images/image-20200318111215968.png)

#### 1.ICMP报文的种类

![image-20200318112014417](/home/qzj/.config/Typora/typora-user-images/image-20200318112014417.png)

![image-20200318112623342](/home/qzj/.config/Typora/typora-user-images/image-20200318112623342.png)

![image-20200318112155613](/home/qzj/.config/Typora/typora-user-images/image-20200318112155613.png)

#### 2.ICMP的应用举例

PING

* 测试两台主机之间的连通性
* 使用了ICMP的回送请求和回答报文
* 是应用层直接使用网络层的例子，没有通过运输层

traceroute 或 tracert

* 用来跟踪一个分组从源点到终点的路径

路由重定向

* 静态路由







### 5.互联网的路由选择协议（网关）

#### 1.有关路由选择协议的几个基本概念

理想的路由算法：

* 算法必须是正确的和完整的
* 算法在计算上应简单
* 算法应能适应通信量和网络拓扑的变化
* 算法应具有稳定性
* 算法应是公平的
* 算法应是最佳的

互联网采用的路由选择协议主要是自适应的（即动态的），分布式路由选择协议

互联网把路由选择协议划分为两大类：

* 内部网关协议IGP，如RIP，OSPF
* 外部网关协议EGP，如BGP

网关

​	连接外网







#### 2.内部网关协议RIP

RIP是一种分布式的基于距离向量的路由选择协议

RIP对”距离“的定义：

* 从一路由器到直接连接的网络的距离定义为1
* 从一路由器到非直接连接的网络的距离定义为所经过的路由器加1

注意：

* RIP的”距离“也称”跳数“
* ”距离“等于16时相当于不可达
* RIP只适用于小型网络
* RIP认为好的路由就是它通过的路由器的数目少

RIP协议的特点：

* 仅和相邻路由器交换信息
* 交换的是自己的路由表
* 按固定的时间间隔交换路由信息

距离向量算法：

![image-20200323125927982](/home/qzj/.config/Typora/typora-user-images/image-20200323125927982.png)

RIP协议的报文格式：

![image-20200323130630429](/home/qzj/.config/Typora/typora-user-images/image-20200323130630429.png)

注意：

* RIP协议使用UDP进行传送（UDP的端口520）
* RIP报文的最大长度是4+20×25 = 504字节
* RIP2还具有简单的鉴别功能
* RIP协议是好消息传播的快，坏消息传播的慢



#### 3.内部网关协议OSPF

OSPF使用分布式的链路状态协议

OSPF的特点：

* 向本自治区系统中所有路由器发送信息

  使用洪泛法，通过输出口向所有相邻的路由器发送信息，但不再往回发送

* 发送与本路由器相邻的所有路由器的链路状态

  包括相邻的路由器以及费用，距离，时延，带宽等

* 只有当链路状态发生变化时，路由器才向所有路由器用洪泛法发送此信息

注意：

* 链路状态数据库
* OSPF更新过程收敛的快
* OSPF将一个自治系统划分为若干区域，每个区域内的路由器最好不超过200个
* OSPF使用层次结构的区域划分，主干区域的标识符规定为0.0.0.0
* 区域边界路由器，主干边界路由器，自治系统边界路由器

OSPF分组：

![image-20200323132609876](/home/qzj/.config/Typora/typora-user-images/image-20200323132609876.png)

注意：

* OSPF直接使用IP数据报传送（IP数据报首部的协议字段值为89）
* OSPF分组使用24字节的固定长度首部

OSPF其他特点：

* OSPF允许管理员给每条路由指派不同的代价
* 如果到同一个目的网络有多条相同代价的路径，那么可以将通信量分配给这几条路径
* 所有在OSPF路由器之间交换的分组都具有鉴别的功能
* OSPF支持可变长度的子网划分和无分类的编址CIDR
* OSPF让每个链路状态都带上一个32位的序号，序号越大状态就越新



OSPF的五种分组类型：

* 问候

  用来发现和维持邻站的可达性

* 数据库描述

* 链路状态请求

* 链路状态更新

  用洪泛法对全网更新链路状态

* 链路状态确认

  对链路更新分组的确认

注意：

* 只要一个路由器的链路状态发生变化，该路由器就要使用链路状态更新分组，用洪泛法向全网更新链路状态

* OSPF使用的是可靠的洪泛法，在收到更新分组后要发送确认





#### 4.外部网关协议BGP

注意：

* BGP力求寻找一条能够到达目的网络且比较好的路由（不能兜圈子），而并非要寻找一条最佳路由。

* BGP采用了路径向量路由选择协议，它与距离向量协议和链路状态协议都有很大的区别。

* BGP支持CIDR

* 由于使用了路径向量的信息，就可以很容易地避免产生兜圈子的路由，能很好的解决”坏消息传播得慢“这个问题

![image-20200323172203528](/home/qzj/.config/Typora/typora-user-images/image-20200323172203528.png)

注意：

* 一旦邻站关系建立了，就要继续维持这种关系
* 撤销路由一次可以撤销许多条，但增加新路由时，每个更新报文只能增加一条

![image-20200323172223303](/home/qzj/.config/Typora/typora-user-images/image-20200323172223303.png)

* OPEN报文：6个字段
* UPDATE报文：5个字段
* KEEPALIVE报文：19个字段
* NOTIFICATION报文：3个字段





#### 5.路由器的构成

### 6.IPv6













### 7.IP多播

#### 1.IP多播的基本概念

![image-20200318083323826](/home/qzj/.config/Typora/typora-user-images/image-20200318083323826.png)

局域网具有硬件多播的功能，因此不需要复制分组，在局域网上的多播组成员都能收到这个分组

多播路由器，多播主干网

IP多播

* 在互联网上进行多播
* 分为在本局域网上进行硬件多播，在互联网的范围进行多播

在多播数据报的目的地址写入的是多播组的标识符，然后设法让加入组的主机IP地址与多播组的标识符关联起来

标识符：IP地址中的D类地址

 多播数据报与一般的IP数据报的区别：使用D类地址

注意：

* 多播地址只能用于目的地址，而不能用于源地址

* 多播数据报不产生ICMP差错报文，若在PING命令后键入多播地址，将永远不会收到响应

#### 2.在局域网上进行硬件多播

以太网多播地址范围：01-00-5E-00-00-00到01-00-5E-7F-FF-FF

![image-20200318091656287](/home/qzj/.config/Typora/typora-user-images/image-20200318091656287.png)

由于多播IP地址与以太网硬件地址的映射关系不是唯一的，因此收到多播数据报的主机，还要在IP层利用软件进行过滤







#### 3.IGMP和多播路由选择协议

IGMP协议是让连接在本地局域网上的多播路由器知道本局域网上是否有主机（某个进程）参加或退出了某个多播组

连接局域网上的多播路由器使用多播路由选择协议

多播转发必须动态地适应多播组成员的变化（这时网络拓扑并未发生变化）

多播数据报可以由没有加入多播组的主机发出，也可通过没有组成员接入的网络



IGMP使用IP数据报传递其报文

IGMP的工作分为两个阶段：

* 主机加入新的多播组时，向多播组的多播地址发送一个IGMP报文
* 本地多播路由器周期性的探询主机，以便知道这些主机是否还继续是组的成员

![image-20200318094724119](/home/qzj/.config/Typora/typora-user-images/image-20200318094724119.png)

多播路由器不需要保留组成员关系的准确记录，只需要知道网络上是否至少还有一台主机是本组成员即可

一台主机上的多个进程都加入了某个多播组



多播路由选择协议尚未标准化

多播路由选择实际上就是要找出源主机为根节点的多播转发树

多播转发树上的路由器不会收到重复的多播数据报

转发多播数据报时使用的方法：

* 洪泛与剪除

  * 这种方法适合于较小的多播组

  * 反向路径广播RPB，创建多播树

    ​	检查数据报是否是从源点经最短路径传过来的

    ​	若有多条相同长度的最短路径，使用IP最小那个路由器

  * 以后就按这个多播树进行转发

  * 若多播转发树的上的路由器发现下游树枝没有该多播组的成员，就把它和下游树枝一起剪除

  * 有新增加的组成员时，可以再接到多播转发树上

* 隧道技术

  * 适用多播组位置在地理上很分散的情况
  * 转化为单播数据报进行发送
  * IP中的IP

* 基于核心的发现技术

  * 对于多播组的大小在较大范围内变化时都适合
  * 给每个多播组指定一个核心路由器，给出它的IP单播地址
  * 创造出转发树
  * 利用隧道技术



### 8.VPN和NAT

#### 1.虚拟专用网VPN

专用地址

![image-20200318102408861](/home/qzj/.config/Typora/typora-user-images/image-20200318102408861.png)

在互联网中的所有路由器，对目的地址是专用地址的数据报一律不进行转发

虚拟专用网VPN：利用公共的互联网作为本机构各专用网之间的通信载体

![image-20200318103750137](/home/qzj/.config/Typora/typora-user-images/image-20200318103750137.png)

以上成为内联网VPN

外联网VPN：一个机构的VPN需要某些外部机构加入时

远程接入VPN



#### 2.网络地址转换NAT

![image-20200318104944685](/home/qzj/.config/Typora/typora-user-images/image-20200318104944685.png)

注意：

* 当NAT路由器具有n个全球IP地址时，专用网内最多可以同时有n台主机接入互联网
* 专用网内的主机轮流使用NAT路由器有限数量的全球IP地址
* 通过NAT路由器的通信必须由专用网内的主机发起
* 专用网内的主机不能充当服务器用

把端口号利用上的情况：

NAPT：网络地址与端口号转换

![image-20200318105830703](/home/qzj/.config/Typora/typora-user-images/image-20200318105830703.png)

把专用网内不同的源IP地址转换成同样的全球IP地址，将源主机采用的端口号转换成不同的新的端口号

NAPT路由器收到应答时，从IP数据报中找到运输层端口，根据不同的端口，从NAPT转换表中找到正确的主机

注意：

* 普通路由器在转发IP地址时，源IP和目的IP不变，但NAT要进行更换IP地址，NAPT还要查看和更换运输层的端口号

### 9.多协议标记交换MPLS

MPLS的特点：

* 支持面向连接的服务质量
* 支持流量工程，平衡网络负载
* 有效地支持虚拟专用网VPN

#### 1.MPLS的工作原理

在MPLS域的入口处，给每一个IP数据报打上固定长度“标记”，然后对打上标记的IP数据报用硬件进行转发，这就使得IP数据报的转发过程大大加快了

标记交换：采用硬件技术对打上标记的IP数据报进行转发

注意：不在第三层使用查找表，而是在第二层用硬件进行转发

![image-20200319215042774](/home/qzj/.config/Typora/typora-user-images/image-20200319215042774.png)

标记交换路由器LSR

标记分配协议LDP

标记交换路径LSP

显式转发路由选择

转发等价类FEC：

转发等价类：路由器按照同样方式对待的IP数据报的集合

![image-20200319215823922](/home/qzj/.config/Typora/typora-user-images/image-20200319215823922.png)

#### 2.MPLS首部的位置与格式

![image-20200319220506450](/home/qzj/.config/Typora/typora-user-images/image-20200319220506450.png)

![image-20200319220447908](/home/qzj/.config/Typora/typora-user-images/image-20200319220447908.png)

## 运输层

### 1.运输层协议概述

#### 1.进程之间的通信

注意：

* 运输层属于面向通信部分的最高层，也是用户功能中的最低层。

* 运输层的分用和复用

* 逻辑通信

* 运输层为应用进程之间提供端到端的逻辑通信

* 运输层对收到的报文进行差错检测。

* 当运输层采用TCP协议时，尽管下面的网络是不可靠的，但这种逻辑通信信道相当于一条全双工的可靠通信。

* 采用UDP协议时，这种逻辑信道仍然是一条不可靠信道。



#### 2.两个主要协议

![image-20200309113030497](/home/qzj/.config/Typora/typora-user-images/image-20200309113030497.png)

传送数据单元：

* 按照OSI，两个对等运输实体在通信时传送的数据单位叫做运输协议数据单元

* 在TCP/IP体系中，根据所使用的协议分别称之为TCP报文段或UDP数据报

UDP：

UDP在传输数据之前不需要先建立连接。远地主机的运输层在受到UDP报文后，不需要给出任何确认。

TCP：

TCP是面向连接的服务。不支持广播和多播服务。

![image-20200309113900132](/home/qzj/.config/Typora/typora-user-images/image-20200309113900132.png)



#### 3.运输层的端口

复用和分用：

* 复用：应用层所有的应用进程都可以通过运输层再传送到网络层。

* 分用：运输层从网络层收到发送给各应用进程的数据后，必须交付指明的各应用进程。

注意：

* 为什么使用端口，而不使用进程标识符？（操作系统的不同）

* 协议端口号

* 软件端口，硬件端口

* TCP/IP的运输层用一个16位的端口号来标志一个端口

* 端口号只具有本地意义，只是为了标志本计算机应用层中的各个进程和在运输层交互时的层间接口。

运输层的端口分为两类：

* 服务器端使用的端口号

  一类称熟知端口号或系统端口号，数值为0～1023

  ![image-20200309121314271](/home/qzj/.config/Typora/typora-user-images/image-20200309121314271.png)

  另一类称登记端口号，数值为1024～49151

* 客户端使用的端口号

  又称短暂端口号，数值为49152～65535，这类端口号仅在客户进程运行时动态选择





### 2.用户数据报协议UDP

#### 1.UDP概述

UDP在IP服务上增加了复用和分用的功能以及差错检测的功能

UDP的主要特点：

* UDP是无连接的

* UDP使用尽最大努力交付

* UDP是面向报文的

  UDP对应用层交下来的报文，既不合并，也不拆分，而是保留这些报文的边界

* UDP没有拥塞控制

* UDP支持一对一、一对多、多对一、多对多的交互通信

* UDP首部开销小



#### 2.UDP的首部格式

UDP有两个字段：数据字段，首部字段

首部字段有8个字节，四个字段，每字段的长度为2个字节

四个字段：

* 源端口
* 目的端口
* 长度
* 检验和

![image-20200311101442350](/home/qzj/.config/Typora/typora-user-images/image-20200311101442350.png)

注意：伪首部既不向下传送也不向上递交，而仅仅是为了计算检验和

UDP计算检验和的方法：

![image-20200311101956056](/home/qzj/.config/Typora/typora-user-images/image-20200311101956056.png)







### 3.传输控制协议TCP概述

#### 1.TCP最主要的特点

* TCP是面向连接的运输层协议

* 每条TCP连接只能是一对一的

* TCP提供可靠交付的服务

* TCP提供全双工的通信

* 面向字节流

  ![image-20200311102927461](/home/qzj/.config/Typora/typora-user-images/image-20200311102927461.png)

  TCP不关心应用进程一次把多长的报文发送到TCP的缓存中，而是根据对方给出的窗口值和当前网络拥塞的程度来决定一个报文段应包含多少个字节。



#### 2.TCP连接

TCP连接的端点叫做套接字或插口

```
套接字socket = (IP地址:端口号)
```

```
TCP连接 ::= {socket1,socket2} = {(IP2:port1),(IP2:port2)}
```

注意：同一个socket却可以表示多种不同的意思





### 4.可靠传输的工作原理

理想的传输条件：

* 传输信道不产生差错。
* 不管发送方以多快的速度发送数据，接受方总是来得及处理收到的数据。

实际情况下解决：

* 当出现差错时让发送方重传出现差错的数据。
* 当接受方来不及处理收到的数据时，及时告诉发送方适当降低发送数据的速度。



#### 1.停止等待协议

"停止等待"就是每发送完一个分组就停止发送，等待对方的确认。

![image-20200311110827535](/home/qzj/.config/Typora/typora-user-images/image-20200311110827535.png)

超时重传：只要超过了一段时间仍然没有收到确认，就认为刚才发送的分组丢失了，因而重传前面发送过的分组。

每发送完一个分组时设置一个超时计时器

注意：

* 在发送完一个分组后，必须暂时保留已发送的分组的副本
* 分组和确认分组都必须进行编号
* 超时计时器设置的重传时间应当比数据在分组传输的平均往返时间更长一些

![image-20200311110539947](/home/qzj/.config/Typora/typora-user-images/image-20200311110539947.png)

B收到重复的分组：

* 丢弃这个重复的分组
* 向A发送确认

A收到重复的确认：

* 收下确认后就丢弃

使用以上确认和重传机制，可以在不可靠的传输网络上实现可靠的通信



自动重传请求（ARQ）：重传的请求是自动进行的，接受方不需要请求发送方重传某个出错的分组。

信道利用率

![image-20200311112235066](/home/qzj/.config/Typora/typora-user-images/image-20200311112235066.png)

流水线传输

​	可连续发送多个分组，不必每发完一个分组就停顿下来等待对方的确认。



#### 2.连续ARQ协议

![image-20200311112739215](/home/qzj/.config/Typora/typora-user-images/image-20200311112739215.png)

位于发送窗口内的5个分组都可以连续发送出去，而不需要等待对方的确认

发送方每收到一个确认，就把发送窗口向前滑动一个分组的位置

接收方采用累积确认，在收到几个分组后，对按序到达的最后一个分组发送确认

Go-back-N（回退N）





### 5.TCP报文段的首部格式

![image-20200312102414646](/home/qzj/.config/Typora/typora-user-images/image-20200312102414646.png)

* **源端口和目的端口**

* **序号**

  序号范围是[0，2<sup>32</sup>  -  1]，序号使用mod 2<sup>32</sup> 运算

  序号字段是本报文段所发送的数据的第一个字节的序号

* **确认号**

  期望收到对方下一个报文段的第一个数据字节的序号

  确认号 = N，到序号N-1为止的所有数据都已正确收到

* **数据偏移**

  指出TCP报文段的首部长度

  数据偏移的最大值是60字节

* **保留**

  目前置0

* **紧急URG**

  URG=1，紧急指针字段有效，TCP把紧急数据插入到本报文数据的最前面

* **确认ACK**

  ACK=1，确认号字段有效

  连接建立后，所有传送的报文段都必须把ACK置1

* **推送PSH**

  PSH=1，尽快交付接收应用进程，而不是等到整个缓存都填满了再向上交付

  推送操作很少使用

* **复位RST**

  RST=1，表明TCP连接中出现严重错误，必须释放连接，然后再重新建立运输连接

  或者，用来拒绝一个非法报文或拒绝打开一个连接

* **同步SYN**

  连接建立时用来同步序号

  SYN=1，表示这是一个连接请求或连接接受报文

* **终止FIN**

  FIN=1，数据发送完毕，要求释放连接

* **窗口**

  窗口指的是发送本报文段的接受窗口

  窗口值作为接收方让发送方设置其发送窗口的依据

* **检验和**

  与UDP一样

  加上12字节的伪首部

* **紧急指针**

  指出本报文段中的紧急数据的字节数

  窗口为0也可发送紧急数据

* **选项**

  最长可达40字节

  * 最大报文长度MSS

    每个TCP报文段中的数据字段的最大长度

    MSS的默认值是536字节

  * 窗口扩大

    占3个字节

    有一个字节表示移位值S

  * 时间戳

    占10字节，时间戳值（4字节），时间戳回送回答字段（4字节）

    时间戳的功能：计算往返时间RTT，防止序号绕回PAWS

  * 选择确认



### 6.TCP可靠传输的实现

#### 1.以字节为单位的滑动窗口

![image-20200312134719914](/home/qzj/.config/Typora/typora-user-images/image-20200312134719914.png)

已发送过的数据，在未收到确认之前都必须暂时保留，以便在超时重传时使用

发送窗口后沿：不动，前移，不可后移

发送窗口前沿：不动，前移，不赞成后移

![image-20200312135622263](/home/qzj/.config/Typora/typora-user-images/image-20200312135622263.png)

![image-20200312135838530](/home/qzj/.config/Typora/typora-user-images/image-20200312135838530.png)

![image-20200312140104331](/home/qzj/.config/Typora/typora-user-images/image-20200312140104331.png)

![image-20200312140211126](/home/qzj/.config/Typora/typora-user-images/image-20200312140211126.png)

发送方的应用进程把字节流写入TCP的发送缓存，接受方的应用进程从TCP的接收缓存中读取字节流

缓存空间和序号空间都是有限的，并且都是循环使用

发送缓存暂时存放：

* 发送应用程序送给发送方TCP准备发送的数据
* TCP已发送出但尚未收到确认的数据

接受缓存暂时存放：

* 按序到达的、但尚未被接收应用程序读取的数据
* 未按序到达的数据

注意：

* 同一时刻，A的发送窗口并不总是和B的接收窗口一样大
* 对于不按序到达的数据该如何处理，TCP标准并无明确规定
* TCP要求接收方必须有积累确认的功能，确认推迟的时间不应超过0.5秒



#### 2.超时重传时间的选择

超时重传时间设置的太短，会引起很多报文段的不必要的重传，使网络负荷增大

设置的过长，会使网络的空闲时间增大，降低了传输效率

![image-20200312141701073](/home/qzj/.config/Typora/typora-user-images/image-20200312141701073.png)

区分有效样本和无效样本：

Karn提出一个算法：计算RTTs时，只要报文段重传，就不采用往返时间样本。

但这样超时重传时间就无法更新

算法修正：

取新的重传时间为旧的2倍，当不再发生报文段重传时，再根据公式计算



#### 3.选择确认SACK

只传送缺少的数据而不重传已经正确到达接收方的数据

SACK文档并没有指明发送方应当怎样响应SACK，因此大多数的实现还是重传所有未被确认的的数据块





### 7.TCP流量控制

#### 1.利用滑动窗口实现流量控制

流量控制就是让发送方的发送速率不要太快，要让接收方来得及接收。

![image-20200312143358405](/home/qzj/.config/Typora/typora-user-images/image-20200312143358405.png)

设有一个持续计时器，当发送零窗口通知后，就启动，到期后发送零窗口探测报文段（仅携带1字节的数据）

![image-20200312143503079](/home/qzj/.config/Typora/typora-user-images/image-20200312143503079.png)



#### 2.TCP的传输效率

发送TCP报文的时机

三种机制：

* 当存放的数据达到MSS字节时
* 应用进程指明，即PSH
* 计时器时限

Nagle算法：

* 把第一个字节先发送出去，当收到确认后，把发送缓存中的所有数据组成一个报文段发送出去
* 当数据达到发送窗口的一半，或达到报文段的最大长度时，立即发送一个报文段。

糊涂窗口综合征

* 缓存已满，发送方与接收方进行1字节或很少字节的收发

解决：

* 让接收方等待一段时间，使得接收缓存有足够空间容纳一个最长报文段，或有一半空闲时间
* 发送方不要发送太小的报文段，而是把数据积累成足够大的报文段，或达到接收方缓存空间的一半大小





### 8.TCP的拥塞控制

#### 1.拥塞控制的一般原理

拥塞：在某段时间内，网络中某一资源的需求超过了该资源所能提供的可用部分，使得网络性能变坏

拥塞控制：

* 防止过多的数据注入到网络中，这样可以使网络中的路由器或链路不过载
* 前提：网络能承受现有的网络负荷
* 是一个全局性的过程
* 而流量控制是点对点的通信控制

![image-20200319205654717](/home/qzj/.config/Typora/typora-user-images/image-20200319205654717.png)

开环控制和闭环控制



#### 2.TCP的拥塞控制方法

四种算法：慢开始，拥塞避免，快重传，快恢复

拥塞窗口cwnd

出现网络拥塞：超时

慢开始：

![image-20200319211004714](/home/qzj/.config/Typora/typora-user-images/image-20200319211004714.png)

发送方在开始时只发送一个报文段，试探一下网络的拥塞情况，然后再逐渐增大cwnd

发送只要收到一个对新报文段的确认，其拥塞窗口就立即加1,不需要等待该轮次所有确认

拥塞避免：

慢开始门限ssthresh

![image-20200319211618838](/home/qzj/.config/Typora/typora-user-images/image-20200319211618838.png)



在拥塞避免阶段，拥塞窗口按线性规律缓慢增长，使网络不容易出现拥塞

![image-20200319211912854](/home/qzj/.config/Typora/typora-user-images/image-20200319211912854.png)

出现网络拥塞时：

* 调整门限值ssthresh = cwnd / 2
* 设置cwnd = 1
* 进入慢开始阶段

快重传：

发送方一连收到3个对同一报文段的重复确认

![image-20200319212437570](/home/qzj/.config/Typora/typora-user-images/image-20200319212437570.png)

不启动慢开始，而是执行快恢复算法

快恢复：

* 调整门限值ssthresh = cwnd / 2
* 设置cwnd = ssthresh
* 执行拥塞避免

也可将拥塞窗口cwnd的值增大一些（增大3个报文段的长度）

![image-20200319213032166](/home/qzj/.config/Typora/typora-user-images/image-20200319213032166.png)

注意：

* 发送方窗口一定不能超过对方给出的接收方窗口值rwnd
* 发送方窗口的上限值 = Min [rwnd ，cwnd]
* rwnd 和 cwnd 中较小的一个控制了发送方发送数据的速率



#### 3.主动队列管理AQM

网络层的策略对TCP拥塞控制影响最大的就是路由器的分组丢弃策略

全局同步现象

主动：不要等到路由器的队列长度已经达到最大值时才不得不丢弃后面到达的分组

随机早期检测RED



### 9.TCP传输连接管理

传输连接有三阶段：连接建立，数据传送，连接释放。

TCP的连接建立采用客户服务器方式。

#### 1.TCP的连接建立

三报文握手：TCP建立连接的过程叫做握手，握手需要在客户端和服务器端交换三个TCP报文段。

![image-20200309102903396](/home/qzj/.config/Typora/typora-user-images/image-20200309102903396.png)

![image-20200309103338128](/home/qzj/.config/Typora/typora-user-images/image-20200309103338128.png)

传输控制块TCB

SYN报文段（SYN=1）不能携带数据，但要消耗一个序列号

SYN=1,ACK=1报文段不能携带数据，要消耗一个序列号

ACK报文段可以携带数据，如果不携带数据则不消耗序列号

（上图中seq=x+1后的报文段的序号仍是seq=x+1）

为什么A最后还要发送一次确认？

​			主要是为了防止已失效的连接请求报文段突然又传送到了B，因而产生错误。







#### 2.TCP的连接释放

![image-20200309105930549](/home/qzj/.config/Typora/typora-user-images/image-20200309105930549.png)

四报文握手（p241）

FIN报文段即使不携带数据，也消耗掉一个序号。

时间等待计时器

MSL（最长报文段寿命）

为什么A在TIME-WAIT状态必须等待2MSL的时间？

*  为了保证A发送的最后一个ACK报文段能够到达B

*  防止已失效的连接请求报文段出现在本连接中

保活计时器







## 应用层

### 1.域名系统DNS

#### 1.域名系统概述

域名系统DNS能够把互联网上的主机名字转换为IP地址

DNS使大多数名字都在本地进行解析，仅少量解析需要在互联网上通信

![image-20200325081927856](/home/qzj/.config/Typora/typora-user-images/image-20200325081927856.png)

#### 2.互联网的域名结构

注意：

* 域名中的标号都由字母和数字组成，每个标号不超过63个字符
* 域名不区分大小写字母，标号中除（-）外不能使用其他标点符号
* 级别最低的域名写在最左边，级别最高的域名写在最右边
* 由多个标号组成的完整域名总共不超过255个字符

![image-20200325083240215](/home/qzj/.config/Typora/typora-user-images/image-20200325083240215.png)

![image-20200325083707971](/home/qzj/.config/Typora/typora-user-images/image-20200325083707971.png)

互联网的名字空间是按照机构的组织来划分的，与物理的网络无关，与IP地址中的“子网”也没有关系



#### 3.域名服务器

DNS服务器的管辖范围不是以“域”为单位，而是以区为单位

![image-20200325084024955](/home/qzj/.config/Typora/typora-user-images/image-20200325084024955.png)

域名服务器：

* 根域名服务器

  所有的根域名服务器都知道所有的顶级域名服务器的域名和IP地址

  互联网的根域名服务器总共只有13个域名，但不是13台机器组成，而是使用了镜像服务器

  采用任播技术

  ![image-20200325085333280](/home/qzj/.config/Typora/typora-user-images/image-20200325085333280.png)

  根域名服务器不直接把待查询的域名直接转换成IP地址，而是告诉本地域名服务器下一步应该找哪个顶级域名服务器

* 顶级域名服务器

  管理该顶级域名服务器注册的所有二级域名

* 权限域名服务器

  负责一个区的域名服务器

* 本地域名服务器

  当一台主机发出DNS查询请求时，这个查询请求报文就发送给本地域名服务器

域名的解析过程：

![image-20200325085742286](/home/qzj/.config/Typora/typora-user-images/image-20200325085742286.png)

![image-20200325085630322](/home/qzj/.config/Typora/typora-user-images/image-20200325085630322.png)

注意：

* 主机向本地域名服务器的查询一般都是采用递归查询
* 本地域名服务器向根域名服务器的查询通常是采用迭代查询
* 在域名服务器中广泛使用高速缓存，用来存放最近查询过的域名以及从何处获得域名映射信息的记录
* 本地域名服务器可以直接向顶级域名服务器进行查询
* 域名服务器应该为每项内容设置计时器并处理超过合理时间的项
* 主机也可从本地域名服务器中下载域名和地址的全部数据库，并经常维护



### 2.文件传送协议

#### 1.FTP

#### 2.TFTP

### 3.远程终端协议TELNET

### 4.万维网

#### 1.URL

#### 2.HTTP

### 5.电子邮件

#### 1.SMTP

#### 2.POP3和IMAP

#### 3.MIME

### 6.动态主机配置DHCP

### 7.简单网络管理

#### 1.SMI

#### 2.MIB

### 8.应用进程跨网络的通信

### 9.P2P应用





